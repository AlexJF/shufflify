"use strict";var shufflifyApp=angular.module("shufflifyApp",["ngSanitize","oauth","ngRoute","spotifyServices","ui.select","ui.bootstrap","truncate"]);shufflifyApp.config(["$routeProvider","$locationProvider","uiSelectConfig",function(a,b,c){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0).hashPrefix("!"),c.theme="bootstrap"}]);var shufflifyApp=angular.module("shufflifyApp");shufflifyApp.controller("MainCtrl",["$scope","$http","$location","SpotifySources","SpotifyLibrary","SpotifyPlaylist","AccessToken","$modal","$q",function(a,b,c,d,e,f,g,h,i){function j(c,d){b.defaults.headers.common.Authorization="Bearer "+g.get().access_token,a.profile=d,a.loadSpotifyData()}function k(){a.profile=null,a.spotifyDataStartedLoading=!1,b.defaults.headers.common.Authorization=null,g.destroy()}function l(){var b=[],c=0;a.selectionData.sources.forEach(function(a){for(var d=0;d<a.total;++d)b.push(c++)});var e=window.chance.pick(b,a.selectionData.totalSongsInDestination);e.sort(function(a,b){return a-b});var f=e.length,g=0,h=0,i=[];return a.selectionData.sources.forEach(function(b){for(var c=b.total,j=[];f>h;){var k=e[h]-g;if(k>=c)break;j.push(k),++h}g+=c,i.push(d.getSourceTracks(b,j).then(null,null,function(b){a.$broadcast("progress:tracks_read",b.delta)}))}),i}function m(){var b=[];return a.selectionData.sources.forEach(function(c){b.push(d.getSourceTracks(c).then(null,null,function(b){a.$broadcast("progress:tracks_read",b.delta)}))}),b}a.host=c.host(),a.localhost="127.0.0.1"==a.host||"localhost"==a.host,a.spotifyData={sources:[],library:[],playlists:[]},a.selectionData={sources:[],totalSongsInSources:0,destination:null,totalSongsInDestination:0,maxSongsDestination:null,ensureUnique:!1},a.newPlaylistName="",a.profile=null,a.spotifyDataStartedLoading=!1,a.$on("oauth:logout",k),a.$on("oauth:expired",k),a.$on("oauth:denied",k),a.$on("oauth:profile",j),a.loadSpotifyData=function(){a.spotifyDataStartedLoading||(a.spotifyDataStartedLoading=!0,d.get().then(function(b){a.spotifyData.sources=b.merged,a.spotifyData.library=b.library,a.spotifyData.playlists=b.playlists}))},a.$watchCollection("selectionData.sources",function(){var b=0;a.selectionData.sources.forEach(function(a){b+=a.total}),a.selectionData.totalSongsInSources=b}),a.$watchCollection("[selectionData.totalSongsInSources, selectionData.maxSongsDestination]",function(){var b=a.selectionData.maxSongsDestination,c=a.selectionData.totalSongsInSources;a.selectionData.totalSongsInDestination=!b&&0!==b||0>b?c:Math.min(b,c)}),a.selectAllSources=function(){a.selectionData.sources=angular.extend(a.spotifyData.sources)},a.clearSourcesSelection=function(){a.selectionData.sources=void 0};var n=["$scope","$modalInstance","selectionData",function(a,b,c){a.selectionData=c,a.playlistInfo={name:null},a.ok=function(){f.addPlaylist(a.playlistInfo.name).then(function(a){b.close(a)})},a.cancel=function(){b.dismiss("cancel")}}];a.addPlaylist=function(){var b=h.open({templateUrl:"views/add_playlist.html",controller:n,windowClass:"add-playlist-dialog",resolve:{selectionData:function(){return a.selectionData}}});b.result.then(function(b){a.selectionData.destination=b})};var o=["$scope","$modalInstance","selectionData",function(a,b,c){a.selectionData=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}],p=["$scope","$modalInstance","selectionData",function(a,b,c){a.selectionData=c,a.progressData={total_songs_to_read:a.selectionData.ensureUnique?a.selectionData.totalSongsInSources:a.selectionData.totalSongsInDestination,total_songs_to_write:a.selectionData.totalSongsInDestination,num_tracks_read:0,num_tracks_written:0,percent_tracks_read:0,percent_tracks_written:0,finished_read:!1,finished_write:!1,write_error:null,read_error:null},a.$watchCollection("[progressData.num_tracks_read, progressData.total_songs_to_read]",function(){a.progressData.percent_tracks_read=a.progressData.num_tracks_read/a.progressData.total_songs_to_read*100}),a.$watchCollection("[progressData.num_tracks_written, progressData.total_songs_to_write]",function(){a.progressData.percent_tracks_written=a.progressData.num_tracks_written/a.progressData.total_songs_to_write*100}),a.$on("progress:tracks_read",function(b,c){a.progressData.num_tracks_read+=c}),a.$on("progress:finished_read",function(){a.progressData.finished_read=!0}),a.$on("progress:tracks_written",function(b,c){a.progressData.num_tracks_written+=c}),a.$on("progress:finished_write",function(){a.progressData.finished_write=!0}),a.$on("progress:read_error",function(b,c){a.progressData.read_error=c}),a.$on("progress:write_error",function(b,c){a.progressData.write_error=c}),a.$on("progress:new_total_write_count",function(b,c){console.log("Old total write count: "+a.progressData.total_songs_to_write),console.log("New total write count: "+c),a.progressData.total_songs_to_write=c}),a.ok=function(){b.close()}}];a.showConfirmDialog=function(){var b=h.open({templateUrl:"views/confirm.html",controller:o,windowClass:"confirm-dialog",resolve:{selectionData:function(){return a.selectionData}}});b.result.then(function(){var b=(h.open({templateUrl:"views/progress.html",controller:p,windowClass:"progress-dialog",backdrop:"static",keyboard:!1,scope:a,resolve:{selectionData:function(){return a.selectionData}}}),a.selectionData.totalSongsInSources==a.selectionData.totalSongsInDestination),c=a.selectionData.ensureUnique,d=null;d=b||c?m():l(),i.all(d).then(function(b){a.$broadcast("progress:finished_read");var d=[];b.forEach(function(a){d=d.concat(a)}),d=d.filter(function(a){return"spotify:track:null"!=a}),c&&(d=d.sort().filter(function(a,b){return!b||a!=d[b-1]}),a.$broadcast("progress:new_total_write_count",d.length)),d.length>a.selectionData.totalSongsInDestination?(d=window.chance.pick(d,a.selectionData.totalSongsInDestination),a.$broadcast("progress:new_total_write_count",d.length)):d=window.chance.shuffle(d),f.setPlaylistTracks(a.selectionData.destination.id,d).then(function(){a.$broadcast("progress:finished_write")},function(b){console.log("Write error: "+b),a.$broadcast("progress:write_error",b)},function(b){a.$broadcast("progress:tracks_written",b.delta)}),console.log("Success")},function(b){console.log("Read error: "+b),a.$broadcast("progress:read_error",b)},function(){})})}}]);var spotifyServices=angular.module("spotifyServices",["oauth"]);spotifyServices.factory("SpotifyLibrary",["$q","$http",function(a,b){function c(c){function d(){var a=b.get("https://api.spotify.com/v1/me/tracks",{params:{limit:1}});a.then(function(a){e.info={id:"library",name:"Your music",type:"library",total:a.data.total},f.resolve(e.info)},function(a){f.reject(a)})}var f=a.defer();return e.info&&!c?f.resolve(e.info):d(),f.promise}function d(c){function d(a){if(a.length<=0)return void f.resolve(g);var e=a.shift();b.get(h,{params:{offset:e.offset,limit:e.limit}}).then(function(b){for(var h=0,i=0;i<b.data.items.length;++i)if(i in e.items){var j=b.data.items[i];g.push(j.track.uri),++h}f.notify({delta:h,current:g.length,total:c.length}),d(a)},function(a){f.reject(a)})}function e(){b.get(h).then(function(a){var b=0;a.data.items.forEach(function(a){null!=a.track&&(g.push(a.track.uri),++b)}),f.notify({delta:b,current:g.length,total:a.total}),a.data.next?(h=a.data.next,e()):f.resolve(g)},function(a){f.reject(a)})}var f=a.defer(),g=[],h="https://api.spotify.com/v1/me/tracks";if(c){var i=[],j=null,k=50;c.forEach(function(a){j&&(a-j.offset+1>k?(i.push(j),j=null):(j.limit=a-j.offset+1,j.items.push(a-j.offset))),j||(j={offset:a,limit:1,items:[0]})}),j&&i.push(j),d(i)}else e();return f.promise}var e={info:null};return{getInfo:c,getTracks:d}}]),spotifyServices.factory("SpotifyPlaylist",["$q","$http","Profile",function(a,b,c){function d(a){return{id:a.id,name:a.name,type:"playlist",total:a.tracks.total,owner:a.owner.id}}function e(e){function f(){b.get(h).then(function(a){a.data.items.forEach(function(a){var b=d(a);m.playlists_info.push(b)}),a.data.next?(h=a.data.next,f()):(l(),g.resolve(m.playlists_info))},function(a){g.reject(a)})}var g=a.defer(),h="https://api.spotify.com/v1/users/"+c.get().id+"/playlists?limit=50";return m.playlists_info.length>0&&!e?g.resolve(m.playlists_info):(m.playlists_info=[],f()),g.promise}function f(c,d){function e(a){if(a.length<=0)return void g.resolve(h);var c=a.shift();b.get(i,{params:{offset:c.offset,limit:c.limit}}).then(function(b){for(var f=0,i=0;i<b.data.items.length;++i)if(i in c.items){var j=b.data.items[i];null!=j.track&&(h.push(j.track.uri),++f)}else console.log("Skipping "+i);g.notify({delta:f,current:h.length,total:d.length}),e(a)},function(a){g.reject(a)})}function f(){b.get(i).then(function(a){var b=0;a.data.items.forEach(function(a){null!=a.track&&(h.push(a.track.uri),++b)}),g.notify({delta:b,current:h.length,total:a.total}),a.data.next?(i=a.data.next,f()):g.resolve(h)},function(a){g.reject(a)})}var g=a.defer(),h=[],i="https://api.spotify.com/v1/users/"+c.owner+"/playlists/"+c.id+"/tracks";if(d){var j=[],k=null,l=100;d.forEach(function(a){k&&(a-k.offset+1>l?(j.push(k),k=null):(k.limit=a-k.offset+1,k.items.push(a-k.offset))),k||(k={offset:a,limit:1,items:[0]})}),k&&j.push(k),e(j)}else f();return g.promise}function g(a){var d=b.put("https://api.spotify.com/v1/users/"+c.get().id+"/playlists/"+a+"/tracks",{uris:[]});return d.then(function(){for(var b=0;b<m.playlists_info.length;++b){var c=m.playlists_info[b];if(c.id==a){c.total=0;break}}})}function h(d,e){function f(a){if(a.length<=0)return void h.resolve(i);var c=a.splice(0,g);b.post(j,{uris:c}).then(function(){i+=c.length,h.notify({delta:c.length,current:i,total:a.length}),f(a)},function(a){h.reject(a)})}var g=100,h=a.defer(),i=0,j="https://api.spotify.com/v1/users/"+c.get().id+"/playlists/"+d+"/tracks";return f(e),h.promise.then(function(){for(var a=0;a<m.playlists_info.length;++a){var b=m.playlists_info[a];if(b.id==d){b.total=i;break}}})}function i(a,b){return g(a).then(function(){return h(a,b)})}function j(a){var e=b.post("https://api.spotify.com/v1/users/"+c.get().id+"/playlists",{name:a,"public":!1});return e.then(function(a){var b=d(a.data);return m.playlists_info.push(b),l(),b})}function k(a,b,c){var d=function(b){return c?c(b[a]):b[a]};return function(a,c){var e=d(a),f=d(c);return(f>e?-1:e>f?1:"function"==typeof then?then(a,c):0)*[1,-1][+!!b]}}function l(){m.playlists_info.sort(k("name"))}var m={playlists_info:[]};return{getPlaylistsInfo:e,getPlaylistTracks:f,setPlaylistTracks:i,addPlaylist:j}}]),spotifyServices.factory("SpotifySources",["$q","SpotifyLibrary","SpotifyPlaylist",function(a,b,c){function d(){return a.all([b.getInfo(!0),c.getPlaylistsInfo(!0)]).then(function(a){return{library:a[0],playlists:a[1],merged:[a[0]].concat(a[1])}})}function e(a,d){return"library"==a.type?b.getTracks(d):c.getPlaylistTracks(a,d)}return{get:d,getSourceTracks:e}}]);