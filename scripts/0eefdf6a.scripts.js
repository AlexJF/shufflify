"use strict";var shufflifyApp=angular.module("shufflifyApp",["ngSanitize","oauth","ngRoute","spotifyServices","ui.select","ui.bootstrap","truncate"]);shufflifyApp.config(["$routeProvider","$locationProvider","uiSelectConfig",function(a,b,c){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0).hashPrefix("!"),c.theme="bootstrap"}]);var shufflifyApp=angular.module("shufflifyApp");shufflifyApp.controller("MainCtrl",["$scope","$http","$location","SpotifySources","SpotifyLibrary","SpotifyPlaylist","AccessToken","$modal","$q",function(a,b,c,d,e,f,g,h,i){function j(c,d){b.defaults.headers.common.Authorization="Bearer "+g.get().access_token,a.profile=d,a.loadSpotifyData()}function k(){a.profile=null,a.spotifyDataStartedLoading=!1,b.defaults.headers.common.Authorization=null,g.destroy()}this.$inject=["$scope","$http","$location","SpotifySources","SpotifyLibrary","SpotifyPlaylist","AccessToken","$modal","$q"],a.host=c.host(),a.localhost="127.0.0.1"==a.host||"localhost"==a.host,a.spotifyData={sources:[],library:[],playlists:[]},a.selectionData={sources:[],totalSongsInSources:0,destination:null,totalSongsInDestination:0,maxSongsDestination:null},a.newPlaylistName="",a.profile=null,a.spotifyDataStartedLoading=!1,a.$on("oauth:logout",k),a.$on("oauth:expired",k),a.$on("oauth:denied",k),a.$on("oauth:profile",j),a.loadSpotifyData=function(){a.spotifyDataStartedLoading||(a.spotifyDataStartedLoading=!0,d.get().then(function(b){a.spotifyData.sources=b.merged,a.spotifyData.library=b.library,a.spotifyData.playlists=b.playlists}))},a.$watchCollection("selectionData.sources",function(){var b=0;a.selectionData.sources.forEach(function(a){b+=a.total}),a.selectionData.totalSongsInSources=b}),a.$watchCollection("[selectionData.totalSongsInSources, selectionData.maxSongsDestination]",function(){var b=a.selectionData.maxSongsDestination,c=a.selectionData.totalSongsInSources;a.selectionData.totalSongsInDestination=!b&&0!==b||0>b?c:Math.min(b,c)});var l=function(a,b,c){a.selectionData=c,a.playlistInfo={name:null},a.ok=function(){f.addPlaylist(a.playlistInfo.name).then(function(a){b.close(a)})},a.cancel=function(){b.dismiss("cancel")}};a.addPlaylist=function(){var b=h.open({templateUrl:"views/add_playlist.html",controller:l,windowClass:"add-playlist-dialog",resolve:{selectionData:function(){return a.selectionData}}});b.result.then(function(b){a.selectionData.destination=b})};var m=function(a,b,c){this.$inject=["$scope","$modalInstance"],a.selectionData=c,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}},n=function(a,b,c){this.$inject=["$scope","$modalInstance"],a.selectionData=c,a.progressData={total_songs:a.selectionData.totalSongsInDestination,num_tracks_read:0,num_tracks_written:0,percent_tracks_read:0,percent_tracks_written:0,finished_read:!1,finished_write:!1,write_error:null,read_error:null},a.$watchCollection("[progressData.num_tracks_read, progressData.total_songs]",function(){a.progressData.percent_tracks_read=a.progressData.num_tracks_read/a.progressData.total_songs*100}),a.$watchCollection("[progressData.num_tracks_written, progressData.total_songs]",function(){a.progressData.percent_tracks_written=a.progressData.num_tracks_written/a.progressData.total_songs*100}),a.$on("progress:tracks_read",function(b,c){a.progressData.num_tracks_read+=c}),a.$on("progress:finished_read",function(){a.progressData.finished_read=!0}),a.$on("progress:tracks_written",function(b,c){a.progressData.num_tracks_written+=c}),a.$on("progress:finished_write",function(){a.progressData.finished_write=!0}),a.$on("progress:read_error",function(b,c){a.progressData.read_error=c}),a.$on("progress:write_error",function(b,c){a.progressData.write_error=c}),a.ok=function(){b.close()}};a.showConfirmDialog=function(){var b=h.open({templateUrl:"views/confirm.html",controller:m,windowClass:"confirm-dialog",resolve:{selectionData:function(){return a.selectionData}}});b.result.then(function(){{var b=[],c=0;h.open({templateUrl:"views/progress.html",controller:n,windowClass:"progress-dialog",backdrop:"static",keyboard:!1,scope:a,resolve:{selectionData:function(){return a.selectionData}}})}a.selectionData.sources.forEach(function(a){for(var d=0;d<a.total;++d)b.push(c++)});var e=window.chance.pick(b,a.selectionData.totalSongsInDestination);e.sort(function(a,b){return a-b});var g=e.length,j=0,k=[];a.selectionData.sources.forEach(function(b){for(var c=j,f=b.total,h=[];g>j;){var i=e[j]-c;if(i>=f)break;h.push(i),++j}k.push(d.getSourceTracks(b,h).then(null,null,function(b){a.$broadcast("progress:tracks_read",b.delta)}))}),i.all(k).then(function(b){a.$broadcast("progress:finished_read");var c=[];b.forEach(function(a){c=c.concat(a)}),f.setPlaylistTracks(a.selectionData.destination.id,c).then(function(){a.$broadcast("progress:finished_write")},function(b){a.$broadcast("progress:write_error",b)},function(b){a.$broadcast("progress:tracks_written",b.delta)}),console.log("Success")},function(b){a.$broadcast("progress:read_error",b)},function(){})})}}]);var spotifyServices=angular.module("spotifyServices",["oauth"]);spotifyServices.factory("SpotifyLibrary",["$q","$http",function(a,b){function c(c){function d(){var a=b.get("https://api.spotify.com/v1/me/tracks",{params:{limit:1}});a.then(function(a){e.info={id:"library",name:"Your music",type:"library",total:a.data.total},f.resolve(e.info)})}var f=a.defer();return e.info&&!c?f.resolve(e.info):d(),f.promise}function d(c){function d(a){if(a.length<=0)return void f.resolve(g);var e=a.shift();b.get(h,{params:{offset:e.offset,limit:e.limit}}).then(function(b){for(var h=0,i=0;i<b.data.items.length;++i)if(i in e.items){var j=b.data.items[i];g.push(j.track.uri),++h}f.notify({delta:h,current:g.length,total:c.length}),d(a)})}function e(){b.get(h).then(function(a){a.data.items.forEach(function(a){g.push(a.track.uri)}),f.notify({delta:a.data.items.length,current:g.length,total:a.total}),a.next?(h=a.next,e()):f.resolve(g)})}var f=a.defer(),g=[],h="https://api.spotify.com/v1/me/tracks";if(c){var i=[],j=null,k=50;c.forEach(function(a){j&&(a-j.offset+1>k?(i.push(j),j=null):(j.limit=a-j.offset+1,j.items.push(a-j.offset))),j||(j={offset:a,limit:1,items:[0]})}),j&&i.push(j),d(i)}else e();return f.promise}this.$inject=["$q","$http"];var e={info:null};return{getInfo:c,getTracks:d}}]),spotifyServices.factory("SpotifyPlaylist",["$q","$http","Profile",function(a,b,c){function d(a){return{id:a.id,name:a.name,type:"playlist",total:a.tracks.total}}function e(e){function f(){b.get(h).then(function(a){a.data.items.forEach(function(a){var b=d(a);m.playlists_info.push(b)}),a.next?(h=a.next,f()):(l(),g.resolve(m.playlists_info))})}var g=a.defer(),h="https://api.spotify.com/v1/users/"+c.get().id+"/playlists?limit=50";return m.playlists_info.length>0&&!e?g.resolve(m.playlists_info):(m.playlists_info=[],f()),g.promise}function f(d,e){function f(a){if(a.length<=0)return void h.resolve(i);var c=a.shift();b.get(k,{params:{fields:j,offset:c.offset,limit:c.limit}}).then(function(b){for(var d=0,g=0;g<b.data.items.length;++g)if(g in c.items){var j=b.data.items[g];i.push(j.track.uri),++d}h.notify({delta:d,current:i.length,total:e.length}),f(a)})}function g(){b.get(k,{params:{fields:j}}).then(function(a){a.data.items.forEach(function(a){i.push(a.track.uri)}),h.notify({delta:a.data.items.length,current:i.length,total:a.total}),a.next?(k=a.next,g()):h.resolve(i)})}var h=a.defer(),i=[],j="items.track.uri",k="https://api.spotify.com/v1/users/"+c.get().id+"/playlists/"+d+"/tracks";if(e){var l=[],m=null,n=100;e.forEach(function(a){m&&(a-m.offset+1>n?(l.push(m),m=null):(m.limit=a-m.offset+1,m.items.push(a-m.offset))),m||(m={offset:a,limit:1,items:[0]})}),m&&l.push(m),f(l)}else g();return h.promise}function g(a){var d=b.put("https://api.spotify.com/v1/users/"+c.get().id+"/playlists/"+a+"/tracks",{uris:[]});return d.then(function(){for(var b=0;b<m.playlists_info.length;++b){var c=m.playlists_info[b];if(c.id==a){c.total=0;break}}})}function h(d,e){function f(a){if(a.length<=0)return void h.resolve(i);var c=a.splice(0,g);b.post(j,{uris:c}).then(function(){i+=c.length,h.notify({delta:c.length,current:i,total:a.length}),f(a)})}var g=100,h=a.defer(),i=0,j="https://api.spotify.com/v1/users/"+c.get().id+"/playlists/"+d+"/tracks";return f(e),h.promise.then(function(){for(var a=0;a<m.playlists_info.length;++a){var b=m.playlists_info[a];if(b.id==d){b.total=i;break}}})}function i(a,b){return g(a).then(function(){return h(a,b)})}function j(a){var e=b.post("https://api.spotify.com/v1/users/"+c.get().id+"/playlists",{name:a,"public":!1});return e.then(function(a){var b=d(a.data);return m.playlists_info.push(b),l(),b})}function k(a,b,c){var d=function(b){return c?c(b[a]):b[a]};return function(a,c){var e=d(a),f=d(c);return(f>e?-1:e>f?1:"function"==typeof then?then(a,c):0)*[1,-1][+!!b]}}function l(){m.playlists_info.sort(k("name"))}this.$inject=["$q","$http","Profile"];var m={playlists_info:[]};return{getPlaylistsInfo:e,getPlaylistTracks:f,setPlaylistTracks:i,addPlaylist:j}}]),spotifyServices.factory("SpotifySources",["$q","SpotifyLibrary","SpotifyPlaylist",function(a,b,c){function d(){return a.all([b.getInfo(!0),c.getPlaylistsInfo(!0)]).then(function(a){return{library:a[0],playlists:a[1],merged:[a[0]].concat(a[1])}})}function e(a,d){return"library"==a.type?b.getTracks(d):c.getPlaylistTracks(a.id,d)}return this.$inject=["$q","SpotifyLibrary","SpotifyPlaylist"],{get:d,getSourceTracks:e}}]);